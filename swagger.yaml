openapi: 3.0.3
info:
  title: Gestor Financiero IA API
  version: "2.0"
  description: |
    API Flask con análisis de gastos, predicciones y recomendaciones de ahorro, integrada con Firebase Firestore.
    Autenticación vía JWT. Muchas rutas aceptan GET con query params para conveniencia.
  contact:
    name: Equipo IA Finanzas
servers:
  - url: http://localhost:5000
    description: Servidor local
  - url: https://your-render-service.onrender.com
    description: Producción (Render)
security:
  - bearerAuth: []
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  parameters:
    UsuarioId:
      in: path
      name: usuario_id
      required: true
      schema:
        type: string
      description: ID del usuario en Firestore (colección users)
  schemas:
    Error:
      type: object
      properties:
        error:
          type: string
        detalle:
          type: string
    StatusSuccess:
      type: object
      properties:
        status:
          type: string
          example: success
    PredictionMonthly:
      type: object
      properties:
        diarias:
          type: array
          items:
            type: object
            properties:
              fecha:
                type: string
                format: date
              prediccion:
                type: number
              min:
                type: number
              max:
                type: number
              semana:
                type: integer
              dia_semana:
                type: string
        total_mes:
          type: number
        promedio_diario:
          type: number
        resumen_semanal:
          type: object
          additionalProperties:
            type: object
            properties:
              total:
                type: number
              promedio_diario:
                type: number
paths:
  /api/v2/health:
    get:
      summary: Estado de la API
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
  /api/v2/auth/token:
    post:
      summary: Obtener token JWT
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                user_id:
                  type: string
      responses:
        '200':
          description: Token generado
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  token:
                    type: string
                  expires_in:
                    type: integer
        '500':
          description: Error generando token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/v2/auth/validate:
    post:
      summary: Validar token JWT
      responses:
        '200':
          description: Validación
          content:
            application/json:
              schema:
                type: object
                properties:
                  valid:
                    type: boolean
  /api/v2/firebase/debug:
    get:
      summary: Diagnóstico Firestore
      responses:
        '200':
          description: Datos de conexión
        '503':
          description: Firebase no disponible
  /api/v2/firebase/usuarios:
    get:
      summary: Listar usuarios (colección users)
      responses:
        '200':
          description: Usuarios listados
        '503':
          description: Firebase no disponible
  /api/v2/firebase/usuarios/{usuario_id}:
    get:
      summary: Obtener usuario con budget/current
      parameters:
        - $ref: '#/components/parameters/UsuarioId'
      responses:
        '200':
          description: Usuario encontrado
        '404':
          description: Usuario no existe
        '503':
          description: Firebase no disponible
  /api/v2/firebase/users/{usuario_id}/gastos:
    get:
      summary: Listar gastos de un usuario
      parameters:
        - $ref: '#/components/parameters/UsuarioId'
        - in: query
          name: ids_only
          schema:
            type: string
            enum: [true, false]
      responses:
        '200':
          description: Lista de gastos
        '503':
          description: Firebase no disponible
    post:
      summary: Crear gasto para un usuario
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/UsuarioId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [cantidad, categoria]
              properties:
                cantidad:
                  type: number
                categoria:
                  type: string
                descripcion:
                  type: string
                fecha:
                  type: string
      responses:
        '201':
          description: Gasto creado
        '400':
          description: Datos inválidos
        '503':
          description: Firebase no disponible
  /api/v2/firebase/users/{usuario_id}/gastos-ids:
    get:
      summary: Listar solo IDs de gastos
      parameters:
        - $ref: '#/components/parameters/UsuarioId'
      responses:
        '200':
          description: OK
        '503':
          description: Firebase no disponible
  /api/v2/firebase/users/{usuario_id}/gastos-procesados:
    get:
      summary: Gastos + resumen IA (por categoría)
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/UsuarioId'
      responses:
        '200':
          description: OK
        '503':
          description: Firebase no disponible

  # Predicción
  /api/v2/firebase/users/{usuario_id}/predict-category:
    get:
      summary: Predicción por categoría (30 días)
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/UsuarioId'
      responses:
        '200':
          description: OK
  /api/v2/firebase/users/{usuario_id}/predict-monthly:
    get:
      summary: Predicción mensual (30 días)
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/UsuarioId'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PredictionMonthly'
  /api/v2/firebase/users/{usuario_id}/detect-anomalies:
    get:
      summary: Detección de anomalías
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/UsuarioId'
      responses:
        '200':
          description: OK
  /api/v2/firebase/users/{usuario_id}/compare-models:
    get:
      summary: Comparación de modelos ML
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/UsuarioId'
      responses:
        '200':
          description: OK
  /api/v2/firebase/users/{usuario_id}/seasonality:
    get:
      summary: Análisis de estacionalidad
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/UsuarioId'
      responses:
        '200':
          description: OK
  /api/v2/firebase/users/{usuario_id}/analysis-complete:
    get:
      summary: Análisis completo (predicciones)
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/UsuarioId'
      responses:
        '200':
          description: OK

  # Estadística
  /api/v2/firebase/users/{usuario_id}/stat/correlations:
    get:
      summary: Correlaciones entre categorías
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/UsuarioId'
      responses:
        '200':
          description: OK
  /api/v2/firebase/users/{usuario_id}/stat/temporal-comparison:
    get:
      summary: Mes actual vs anterior
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/UsuarioId'
      responses:
        '200':
          description: OK
  /api/v2/firebase/users/{usuario_id}/stat/clustering:
    get:
      summary: Clustering de gastos
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/UsuarioId'
        - in: query
          name: n_clusters
          schema:
            type: integer
            default: 3
      responses:
        '200':
          description: OK
  /api/v2/firebase/users/{usuario_id}/stat/trends:
    get:
      summary: Detección de tendencias
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/UsuarioId'
      responses:
        '200':
          description: OK
  /api/v2/firebase/users/{usuario_id}/stat/outliers:
    get:
      summary: Outliers (IQR + Z-Score)
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/UsuarioId'
      responses:
        '200':
          description: OK
  /api/v2/firebase/users/{usuario_id}/stat/complete:
    get:
      summary: Estadístico completo
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/UsuarioId'
      responses:
        '200':
          description: OK

  # Ahorro y salud financiera
  /api/v2/firebase/users/{usuario_id}/savings/goals:
    get:
      summary: Metas de ahorro
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/UsuarioId'
        - in: query
          name: goal_name
          schema:
            type: string
        - in: query
          name: target_amount
          schema:
            type: number
            default: 1000
        - in: query
          name: months
          schema:
            type: integer
            default: 12
      responses:
        '200':
          description: OK
  /api/v2/firebase/users/{usuario_id}/savings/tips:
    get:
      summary: Tips personalizados
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/UsuarioId'
      responses:
        '200':
          description: OK
  /api/v2/firebase/users/{usuario_id}/savings/budget-alerts:
    get:
      summary: Alertas de presupuesto
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/UsuarioId'
        - in: query
          name: monthly_budget
          schema:
            type: number
            default: 3000
      responses:
        '200':
          description: OK
  /api/v2/firebase/users/{usuario_id}/savings/health-score:
    get:
      summary: Puntuación financiera
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/UsuarioId'
        - in: query
          name: monthly_budget
          schema:
            type: number
            default: 3000
      responses:
        '200':
          description: OK
  /api/v2/firebase/users/{usuario_id}/savings/weekly-report:
    get:
      summary: Reporte semanal
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/UsuarioId'
      responses:
        '200':
          description: OK
  /api/v2/firebase/users/{usuario_id}/savings/complete:
    get:
      summary: Ahorro completo (todos módulos)
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/UsuarioId'
        - in: query
          name: goal_name
          schema:
            type: string
        - in: query
          name: target_amount
          schema:
            type: number
            default: 5000
        - in: query
          name: months
          schema:
            type: integer
            default: 12
        - in: query
          name: monthly_budget
          schema:
            type: number
            default: 3000
      responses:
        '200':
          description: OK

  # Gráficos
  /api/v2/firebase/users/{usuario_id}/charts/heatmap:
    get:
      summary: Calendario de calor
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/UsuarioId'
      responses:
        '200':
          description: OK (si Plotly disponible)
  /api/v2/firebase/users/{usuario_id}/charts/sankey:
    get:
      summary: Diagrama Sankey
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/UsuarioId'
      responses:
        '200':
          description: OK
  /api/v2/firebase/users/{usuario_id}/charts/dashboard:
    get:
      summary: Dashboard interactivo
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/UsuarioId'
      responses:
        '200':
          description: OK
  /api/v2/firebase/users/{usuario_id}/charts/comparison:
    get:
      summary: Comparativas mes vs mes
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/UsuarioId'
      responses:
        '200':
          description: OK
  /api/v2/firebase/users/{usuario_id}/charts/export:
    get:
      summary: Exportar gráficos
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/UsuarioId'
        - in: query
          name: format
          schema:
            type: string
            enum: [json, base64]
            default: json
      responses:
        '200':
          description: OK
  /api/v2/firebase/users/{usuario_id}/charts/complete:
    get:
      summary: Todos los gráficos
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/UsuarioId'
      responses:
        '200':
          description: OK
